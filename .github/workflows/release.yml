# Release workflow for lex-vscode
# Builds VSIX packages with bundled lex-lsp for each platform

name: Release
permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: darwin-x64
            os: macos-latest
            lex_lsp_target: x86_64-apple-darwin
          - target: darwin-arm64
            os: macos-latest
            lex_lsp_target: aarch64-apple-darwin
          - target: linux-x64
            os: ubuntu-latest
            lex_lsp_target: x86_64-unknown-linux-gnu
          - target: linux-arm64
            os: ubuntu-latest
            lex_lsp_target: aarch64-unknown-linux-gnu
          - target: win32-x64
            os: windows-latest
            lex_lsp_target: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build shared module
        run: |
          cd shared
          npm ci
          npm run build

      - name: Install dependencies
        run: npm ci

      - name: Download lex-lsp binary
        shell: bash
        run: |
          LEX_LSP_VERSION="${{ github.ref_name }}"
          # Use the same version tag, or fall back to a known version
          LEX_LSP_RELEASE_VERSION="v0.2.2"

          mkdir -p resources

          if [[ "${{ matrix.target }}" == win32-* ]]; then
            ARCHIVE_NAME="lex-lsp-${{ matrix.lex_lsp_target }}.zip"
            BINARY_NAME="lex-lsp.exe"
          else
            ARCHIVE_NAME="lex-lsp-${{ matrix.lex_lsp_target }}.tar.gz"
            BINARY_NAME="lex-lsp"
          fi

          DOWNLOAD_URL="https://github.com/lex-fmt/editors/releases/download/${LEX_LSP_RELEASE_VERSION}/${ARCHIVE_NAME}"
          echo "Downloading from: $DOWNLOAD_URL"

          curl -fsSL -o "/tmp/${ARCHIVE_NAME}" "$DOWNLOAD_URL"

          if [[ "${{ matrix.target }}" == win32-* ]]; then
            cd /tmp && unzip -q "${ARCHIVE_NAME}" && cd -
          else
            tar -xzf "/tmp/${ARCHIVE_NAME}" -C /tmp
          fi

          cp "/tmp/${BINARY_NAME}" "resources/${BINARY_NAME}"
          chmod +x "resources/${BINARY_NAME}" || true

      - name: Build extension
        run: npm run bundle

      - name: Package VSIX
        run: |
          npx @vscode/vsce package --target ${{ matrix.target }} -o lex-${{ matrix.target }}.vsix

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lex-${{ matrix.target }}
          path: lex-${{ matrix.target }}.vsix

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*.vsix
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
