# Release workflow for lex-vscode
# Builds VSIX packages for VS Code Marketplace and Open VSX (VSCodium)
# Both use identical platform-specific packages with bundled lex-lsp binaries

name: Release
permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: darwin-x64
            os: macos-latest
            lex_lsp_target: x86_64-apple-darwin
          - target: darwin-arm64
            os: macos-latest
            lex_lsp_target: aarch64-apple-darwin
          - target: linux-x64
            os: ubuntu-latest
            lex_lsp_target: x86_64-unknown-linux-gnu
          - target: linux-arm64
            os: ubuntu-latest
            lex_lsp_target: aarch64-unknown-linux-gnu
          - target: win32-x64
            os: windows-latest
            lex_lsp_target: x86_64-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Build shared module
        run: |
          cd shared
          npm ci
          npm run build

      - name: Install dependencies
        run: npm ci

      - name: Download assets from comms
        shell: bash
        run: |
          COMMS_VERSION="v0.9.1"
          curl -fsSL -o /tmp/assets.tar.gz "https://github.com/lex-fmt/comms/releases/download/${COMMS_VERSION}/assets.tar.gz"
          tar -xzf /tmp/assets.tar.gz -C /tmp
          cp /tmp/assets/logo@128.png icon.png

      - name: Download lex-lsp binary
        shell: bash
        run: |
          # Read pinned version from shared/lex-deps.json
          LEX_LSP_VERSION=$(jq -r '.["lex-lsp"]' shared/lex-deps.json)
          LEX_LSP_REPO=$(jq -r '.["lex-lsp-repo"]' shared/lex-deps.json)
          echo "Using lex-lsp version: $LEX_LSP_VERSION from $LEX_LSP_REPO"

          mkdir -p resources

          if [[ "${{ matrix.target }}" == win32-* ]]; then
            ARCHIVE_NAME="lex-lsp-${{ matrix.lex_lsp_target }}.zip"
            BINARY_NAME="lex-lsp.exe"
          else
            ARCHIVE_NAME="lex-lsp-${{ matrix.lex_lsp_target }}.tar.gz"
            BINARY_NAME="lex-lsp"
          fi

          DOWNLOAD_URL="https://github.com/${LEX_LSP_REPO}/releases/download/${LEX_LSP_VERSION}/${ARCHIVE_NAME}"
          echo "Downloading from: $DOWNLOAD_URL"

          curl -fsSL -o "/tmp/${ARCHIVE_NAME}" "$DOWNLOAD_URL"

          if [[ "${{ matrix.target }}" == win32-* ]]; then
            cd /tmp && unzip -q "${ARCHIVE_NAME}" && cd -
          else
            tar -xzf "/tmp/${ARCHIVE_NAME}" -C /tmp
          fi

          cp "/tmp/${BINARY_NAME}" "resources/${BINARY_NAME}"
          chmod +x "resources/${BINARY_NAME}" || true

      - name: Build extension
        run: npm run bundle

      - name: Package VSIX for VS Code Marketplace
        run: |
          npx @vscode/vsce package --target ${{ matrix.target }} -o lex-vscode-${{ matrix.target }}.vsix

      - name: Package VSIX for Open VSX (VSCodium)
        run: |
          npx @vscode/vsce package --target ${{ matrix.target }} -o lex-openvsx-${{ matrix.target }}.vsix

      - name: Upload VS Code artifact
        uses: actions/upload-artifact@v4
        with:
          name: vscode-${{ matrix.target }}
          path: lex-vscode-${{ matrix.target }}.vsix

      - name: Upload Open VSX artifact
        uses: actions/upload-artifact@v4
        with:
          name: openvsx-${{ matrix.target }}
          path: lex-openvsx-${{ matrix.target }}.vsix

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*.vsix
          generate_release_notes: true
          body: |
            ## Installation

            ### VS Code Marketplace
            Download the `lex-vscode-<platform>.vsix` file for your platform:
            - `lex-vscode-darwin-arm64.vsix` - macOS Apple Silicon
            - `lex-vscode-darwin-x64.vsix` - macOS Intel
            - `lex-vscode-linux-x64.vsix` - Linux x64
            - `lex-vscode-linux-arm64.vsix` - Linux ARM64
            - `lex-vscode-win32-x64.vsix` - Windows x64

            ### Open VSX / VSCodium
            Download the `lex-openvsx-<platform>.vsix` file for your platform:
            - `lex-openvsx-darwin-arm64.vsix` - macOS Apple Silicon
            - `lex-openvsx-darwin-x64.vsix` - macOS Intel
            - `lex-openvsx-linux-x64.vsix` - Linux x64
            - `lex-openvsx-linux-arm64.vsix` - Linux ARM64
            - `lex-openvsx-win32-x64.vsix` - Windows x64

            Install via: `code --install-extension <file>.vsix` or `codium --install-extension <file>.vsix`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
